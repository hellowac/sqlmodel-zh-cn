# æ›´æ–°å’Œç§»é™¤å¤šå¯¹å¤šå…³ç³»

ç°åœ¨æˆ‘ä»¬æ¥å­¦ä¹ å¦‚ä½•æ›´æ–°å’Œç§»é™¤è¿™äº› **å¤šå¯¹å¤š** å…³ç³»ã€‚

æˆ‘ä»¬å°†ç»§ç»­ä¹‹å‰çš„ä»£ç ã€‚

/// details | ğŸ‘€ æŸ¥çœ‹å®Œæ•´æ–‡ä»¶é¢„è§ˆ

//// tab | Python 3.10+

```Python
{!./docs_src/tutorial/many_to_many/tutorial001_py310.py!}
```

////

//// tab | Python 3.9+

```Python
{!./docs_src/tutorial/many_to_many/tutorial001_py39.py!}
```

////

//// tab | Python 3.7+

```Python
{!./docs_src/tutorial/many_to_many/tutorial001.py!}
```

////

///

## è·å–å¾…æ›´æ–°çš„æ•°æ®

ç°åœ¨æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªå‡½æ•° `update_heroes()`ã€‚

æˆ‘ä»¬å°†è·å– **Spider-Boy** å’Œ **Z-Force** å›¢é˜Ÿã€‚

ç”±äºä½ å·²ç»ç†Ÿæ‚‰åŸºæœ¬çš„æ“ä½œï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ **ç®€çŸ­ç‰ˆæœ¬**ï¼Œåœ¨ä¸€ä¸ª Python è¯­å¥ä¸­è·å–è¿™äº›æ•°æ®ã€‚

æ­¤å¤–ï¼Œç”±äºæˆ‘ä»¬ä½¿ç”¨äº† `select()`ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶å¯¼å…¥ã€‚

//// tab | Python 3.10+

```Python hl_lines="1  5-10"
{!./docs_src/tutorial/many_to_many/tutorial002_py310.py[ln:1]!}

# è¿™é‡Œçœç•¥äº†ä¸€äº›ä»£ç  ğŸ‘ˆ

{!./docs_src/tutorial/many_to_many/tutorial002_py310.py[ln:72-77]!}

# ä¸‹æ–¹ä»£ç è¢«çœç•¥ ğŸ‘‡
```

////

//// tab | Python 3.9+

```Python hl_lines="3  7-12"
{!./docs_src/tutorial/many_to_many/tutorial002_py39.py[ln:1-3]!}

# è¿™é‡Œçœç•¥äº†ä¸€äº›ä»£ç  ğŸ‘ˆ

{!./docs_src/tutorial/many_to_many/tutorial002_py39.py[ln:78-83]!}

# ä¸‹æ–¹ä»£ç è¢«çœç•¥ ğŸ‘‡
```

////

//// tab | Python 3.7+

```Python hl_lines="3  7-12"
{!./docs_src/tutorial/many_to_many/tutorial002.py[ln:1-3]!}

# è¿™é‡Œçœç•¥äº†ä¸€äº›ä»£ç  ğŸ‘ˆ

{!./docs_src/tutorial/many_to_many/tutorial002.py[ln:78-83]!}

# ä¸‹æ–¹ä»£ç è¢«çœç•¥ ğŸ‘‡
```

////

/// details | ğŸ‘€ æŸ¥çœ‹å®Œæ•´æ–‡ä»¶é¢„è§ˆ

//// tab | Python 3.10+

```Python
{!./docs_src/tutorial/many_to_many/tutorial002_py310.py!}
```

////

//// tab | Python 3.9+

```Python
{!./docs_src/tutorial/many_to_many/tutorial002_py39.py!}
```

////

//// tab | Python 3.7+

```Python
{!./docs_src/tutorial/many_to_many/tutorial002.py!}
```

////

///

å½“ç„¶ï¼Œæˆ‘ä»¬éœ€è¦å°† `update_heroes()` æ·»åŠ åˆ° `main()` å‡½æ•°ä¸­ï¼š

//// tab | Python 3.10+

```Python hl_lines="6"
# ä¸Šæ–¹ä»£ç è¢«çœç•¥ ğŸ‘†

{!./docs_src/tutorial/many_to_many/tutorial002_py310.py[ln:94-101]!}
```

////

//// tab | Python 3.9+

```Python hl_lines="6"
# ä¸Šæ–¹ä»£ç è¢«çœç•¥ ğŸ‘†

{!./docs_src/tutorial/many_to_many/tutorial002_py39.py[ln:100-107]!}
```

////

//// tab | Python 3.7+

```Python hl_lines="6"
# ä¸Šæ–¹ä»£ç è¢«çœç•¥ ğŸ‘†

{!./docs_src/tutorial/many_to_many/tutorial002.py[ln:100-107]!}
```

////

/// details | ğŸ‘€ æŸ¥çœ‹å®Œæ•´æ–‡ä»¶é¢„è§ˆ

//// tab | Python 3.10+

```Python
{!./docs_src/tutorial/many_to_many/tutorial002_py310.py!}
```

////

//// tab | Python 3.9+

```Python
{!./docs_src/tutorial/many_to_many/tutorial002_py39.py!}
```

////

//// tab | Python 3.7+

```Python
{!./docs_src/tutorial/many_to_many/tutorial002.py!}
```

////

///

## æ·»åŠ å¤šå¯¹å¤šå…³ç³»

ç°åœ¨ï¼Œå‡è®¾ **Spider-Boy** è§‰å¾— **Z-Force** å›¢é˜Ÿç‰¹åˆ«é…·ï¼Œå†³å®šåŠ å…¥ä»–ä»¬ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŒæ ·çš„ **å…³ç³»å±æ€§**ï¼Œå°† `hero_spider_boy` æ·»åŠ åˆ° `team_z_force.heroes` ä¸­ã€‚

//// tab | Python 3.10+

```Python hl_lines="10-12  14-15"
# ä¸Šæ–¹ä»£ç è¢«çœç•¥ ğŸ‘†

{!./docs_src/tutorial/many_to_many/tutorial002_py310.py[ln:72-84]!}

# ä¸‹æ–¹ä»£ç è¢«çœç•¥ ğŸ‘‡
```

////

//// tab | Python 3.9+

```Python hl_lines="10-12  14-15"
# ä¸Šæ–¹ä»£ç è¢«çœç•¥ ğŸ‘†

{!./docs_src/tutorial/many_to_many/tutorial002_py39.py[ln:78-90]!}

# ä¸‹æ–¹ä»£ç è¢«çœç•¥ ğŸ‘‡
```

////

//// tab | Python 3.7+

```Python hl_lines="10-12  14-15"
# ä¸Šæ–¹ä»£ç è¢«çœç•¥ ğŸ‘†

{!./docs_src/tutorial/many_to_many/tutorial002.py[ln:78-90]!}

# ä¸‹æ–¹ä»£ç è¢«çœç•¥ ğŸ‘‡
```

////

/// details | ğŸ‘€ æŸ¥çœ‹å®Œæ•´æ–‡ä»¶é¢„è§ˆ

//// tab | Python 3.10+

```Python
{!./docs_src/tutorial/many_to_many/tutorial002_py310.py!}
```

////

//// tab | Python 3.9+

```Python
{!./docs_src/tutorial/many_to_many/tutorial002_py39.py!}
```

////

//// tab | Python 3.7+

```Python
{!./docs_src/tutorial/many_to_many/tutorial002.py!}
```

////

///

/// tip

ç”±äºæˆ‘ä»¬åœ¨æäº¤åç«‹å³è®¿é—®æ¨¡å‹ä¸­çš„å±æ€§ï¼ˆå¦‚ `hero_spider_boy.teams` å’Œ `team_z_force.heroes`ï¼‰ï¼Œæ•°æ®ä¼šè‡ªåŠ¨åˆ·æ–°ã€‚

å› æ­¤ï¼Œæ— éœ€è°ƒç”¨ `session.refresh()`ã€‚

///

ç„¶åæˆ‘ä»¬æäº¤æ›´æ”¹ã€åˆ·æ–°å¹¶æ‰“å°æ›´æ–°åçš„ **Spider-Boy** çš„é˜Ÿä¼ä»¥ç¡®è®¤ã€‚

æ³¨æ„ï¼Œæˆ‘ä»¬åªå°† **Z-Force** æ·»åŠ åˆ°ä¼šè¯ä¸­ï¼Œç„¶åæäº¤ã€‚

æˆ‘ä»¬ä»æœªå°† **Spider-Boy** æ·»åŠ åˆ°ä¼šè¯ä¸­ï¼Œä¹Ÿä»æœªåˆ·æ–°å®ƒã€‚ä½†æˆ‘ä»¬ä»ç„¶æ‰“å°äº†ä»–çš„é˜Ÿä¼ã€‚

è¿™ä¸€åˆ‡èƒ½å¤Ÿæ­£å¸¸å·¥ä½œæ˜¯å› ä¸ºåœ¨æ¨¡å‹ä¸­çš„ `Relationship()` ä½¿ç”¨äº† `back_populates`ã€‚è¿™æ ·ï¼Œ**SQLModel**ï¼ˆå®é™…ä¸Šæ˜¯ SQLAlchemyï¼‰å¯ä»¥è·Ÿè¸ªæ›´æ”¹å’Œæ›´æ–°ï¼Œå¹¶ç¡®ä¿è¿™äº›æ›´æ–°ä¹Ÿä¼šå‘ç”Ÿåœ¨å…¶ä»–ç›¸å…³æ¨¡å‹çš„å…³ç³»ä¸­ã€‚ğŸ‰

## è¿è¡Œç¨‹åº

æ‚¨å¯ä»¥é€šè¿‡åœ¨å‘½ä»¤è¡Œè¿è¡Œç¨‹åºæ¥ç¡®è®¤ä¸€åˆ‡æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š

<div class="termy">

```console
$ python app.py

// ä¸Šé¢çš„è¾“å‡ºçœç•¥ ğŸ™ˆ

// åˆ›å»ºæ–°çš„å¤šå¯¹å¤šå…³ç³»
INFO Engine INSERT INTO heroteamlink (team_id, hero_id) VALUES (?, ?)
INFO Engine [ç”Ÿæˆäº 0.00020s] (1, 3)
INFO Engine COMMIT

// å¼€å§‹ä¸€ä¸ªæ–°çš„è‡ªåŠ¨äº‹åŠ¡
INFO Engine BEGIN (implicit)

// è®¿é—®å±æ€§ .teams æ—¶è‡ªåŠ¨åˆ·æ–°æ•°æ®
INFO Engine SELECT hero.id AS hero_id, hero.name AS hero_name, hero.secret_name AS hero_secret_name, hero.age AS hero_age
FROM hero
WHERE hero.id = ?
INFO Engine [ç”Ÿæˆäº 0.00044s] (3,)
INFO Engine SELECT team.id AS team_id, team.name AS team_name, team.headquarters AS team_headquarters
FROM team, heroteamlink
WHERE ? = heroteamlink.hero_id AND team.id = heroteamlink.team_id
INFO Engine [ç¼“å­˜è‡ª 0.1648s å‰] (3,)

// æ‰“å° Spider-Boy çš„é˜Ÿä¼ï¼ŒåŒ…æ‹¬ Z-Force ğŸ‰
æ›´æ–°åçš„ Spider-Boy çš„é˜Ÿä¼: [
    Team(id=2, name='Preventers', headquarters='Sharp Tower'),
    Team(id=1, name='Z-Force', headquarters='Sister Margaret's Bar')
]

// è®¿é—®å±æ€§ .heroes æ—¶è‡ªåŠ¨åˆ·æ–°æ•°æ®
INFO Engine SELECT hero.id AS hero_id, hero.name AS hero_name, hero.secret_name AS hero_secret_name, hero.age AS hero_age
FROM hero, heroteamlink
WHERE ? = heroteamlink.team_id AND hero.id = heroteamlink.hero_id
INFO Engine [ç¼“å­˜è‡ª 0.1499s å‰] (1,)

// æ‰“å° Z-Force çš„è‹±é›„ï¼ŒåŒ…æ‹¬ Spider-Boy ğŸ‰
Z-Force çš„è‹±é›„: [
    Hero(name='Deadpond', age=None, id=1, secret_name='Dive Wilson'),
    Hero(name='Spider-Boy', age=None, id=3, secret_name='Pedro Parqueador', teams=[
        Team(id=2, name='Preventers', headquarters='Sharp Tower'),
        Team(id=1, name='Z-Force', headquarters='Sister Margaret's Bar', heroes=[...])
    ])
]
```

</div>

## ç§»é™¤å¤šå¯¹å¤šå…³ç³»

ç°åœ¨ï¼Œå‡è®¾ **Spider-Boy** åŠ å…¥å›¢é˜Ÿåï¼Œå‘ç°ä»–ä»¬çš„â€œç”Ÿå‘½ä¿æŠ¤æ”¿ç­–â€æ¯”ä»–ä¹ æƒ¯çš„è¦å®½æ¾å¾—å¤šã€‚ğŸ’€

è€Œä¸”ä»–ä»¬çš„ *èŒä¸šå®‰å…¨å’Œå¥åº·* ä¹Ÿä¸å¦‚é¢„æœŸ... ğŸ’¥

æ‰€ä»¥ï¼Œ**Spider-Boy** å†³å®šç¦»å¼€ **Z-Force**ã€‚

è®©æˆ‘ä»¬æ›´æ–°å…³ç³»ï¼Œç§»é™¤ `hero_spider_boy.teams` ä¸­çš„ `team_z_force`ã€‚

ç”±äº `hero_spider_boy.teams` åªæ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼ˆå®é™…ä¸Šæ˜¯ç”± SQLAlchemy ç®¡ç†çš„ç‰¹æ®Šåˆ—è¡¨ï¼Œä½†ä»ç„¶æ˜¯åˆ—è¡¨ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ ‡å‡†çš„åˆ—è¡¨æ–¹æ³•ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ `.remove()` æ–¹æ³•ï¼Œå®ƒæ¥å—ä¸€ä¸ªé¡¹ç›®å¹¶å°†å…¶ä»åˆ—è¡¨ä¸­ç§»é™¤ã€‚

//// tab | Python 3.10+

```Python hl_lines="17-19  21-22"
# ä¸Šæ–¹ä»£ç çœç•¥ ğŸ‘†

{!./docs_src/tutorial/many_to_many/tutorial002_py310.py[ln:72-91]!}

# ä¸‹æ–¹ä»£ç çœç•¥ ğŸ‘‡
```

////

//// tab | Python 3.9+

```Python hl_lines="17-19  21-22"
# ä¸Šæ–¹ä»£ç çœç•¥ ğŸ‘†

{!./docs_src/tutorial/many_to_many/tutorial002_py39.py[ln:78-97]!}

# ä¸‹æ–¹ä»£ç çœç•¥ ğŸ‘‡
```

////

//// tab | Python 3.7+

```Python hl_lines="17-19  21-22"
# ä¸Šæ–¹ä»£ç çœç•¥ ğŸ‘†

{!./docs_src/tutorial/many_to_many/tutorial002.py[ln:78-97]!}

# ä¸‹æ–¹ä»£ç çœç•¥ ğŸ‘‡
```

////

/// details | ğŸ‘€ æŸ¥çœ‹å®Œæ•´æ–‡ä»¶é¢„è§ˆ

//// tab | Python 3.10+

```Python
{!./docs_src/tutorial/many_to_many/tutorial002_py310.py!}
```

////

//// tab | Python 3.9+

```Python
{!./docs_src/tutorial/many_to_many/tutorial002_py39.py!}
```

////

//// tab | Python 3.7+

```Python
{!./docs_src/tutorial/many_to_many/tutorial002.py!}
```

////

///

è¿™æ¬¡ï¼Œæˆ‘ä»¬å†æ¬¡å±•ç¤ºï¼Œä½¿ç”¨ `back_populates` æ—¶ï¼Œ**SQLModel**ï¼ˆå®é™…ä¸Šæ˜¯ SQLAlchemyï¼‰ä¼šè‡ªåŠ¨å¤„ç†é€šè¿‡å…³ç³»è¿æ¥æ¨¡å‹çš„å·¥ä½œï¼Œå³ä½¿æˆ‘ä»¬æ˜¯ä» `hero_spider_boy` å¯¹è±¡ï¼ˆä¿®æ”¹ `hero_spider_boy.teams`ï¼‰æ‰§è¡Œæ“ä½œï¼Œå®é™…ä¸Šæˆ‘ä»¬æ˜¯åœ¨å°† `team_z_force` æ·»åŠ åˆ° **ä¼šè¯** ä¸­ï¼Œå¹¶æäº¤å®ƒï¼Œè€Œä¸éœ€è¦æ˜¾å¼åœ°æ·»åŠ  `hero_spider_boy`ã€‚

è¿™ä¾ç„¶æœ‰æ•ˆï¼Œå› ä¸ºé€šè¿‡æ›´æ–° `hero_spider_boy` ä¸­çš„é˜Ÿä¼ï¼ˆå®ƒä»¬ä¸ `back_populates` åŒæ­¥ï¼‰ï¼Œè¿™äº›æ›´æ”¹ä¹Ÿä¼šåæ˜ åˆ° `team_z_force` ä¸­ï¼Œå› æ­¤å®ƒä¹Ÿæœ‰æ›´æ”¹éœ€è¦ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼ˆå³ **Spider-Boy** è¢«ç§»é™¤ï¼‰ã€‚

ç„¶åï¼Œæˆ‘ä»¬å°†è¯¥å›¢é˜Ÿæ·»åŠ åˆ°ä¼šè¯ï¼Œå¹¶æäº¤æ›´æ”¹ï¼Œä»è€Œæ›´æ–° `team_z_force` å¯¹è±¡ã€‚ç”±äºå®ƒæ›´æ”¹äº†ä¸ `hero_spider_boy` ç›¸å…³è”çš„è¡¨ï¼Œå®ƒä¹Ÿä¼šåœ¨å†…éƒ¨æ ‡è®°ä¸ºå·²æ›´æ–°ï¼Œå› æ­¤ä¸€åˆ‡éƒ½æ­£å¸¸å·¥ä½œã€‚

æœ€åï¼Œæˆ‘ä»¬å†æ¬¡æ‰“å°å®ƒä»¬ï¼Œä»¥ç¡®è®¤ä¸€åˆ‡æ˜¯å¦æ­£å¸¸ã€‚

## å†æ¬¡è¿è¡Œç¨‹åº

ä¸ºäº†ç¡®è®¤æœ€åçš„éƒ¨åˆ†æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œæ‚¨å¯ä»¥å†æ¬¡è¿è¡Œç¨‹åºï¼Œå®ƒä¼šè¾“å‡ºç±»ä¼¼å¦‚ä¸‹å†…å®¹ï¼š

<div style="font-size: 1rem;" class="termy">

```console
$ python app.py

// ä¸Šé¢çš„è¾“å‡ºçœç•¥ ğŸ™ˆ

// åˆ é™¤è¿æ¥è¡¨ä¸­çš„è¡Œ
INFO Engine DELETE FROM heroteamlink WHERE heroteamlink.team_id = ? AND heroteamlink.hero_id = ?
INFO Engine [ç”Ÿæˆäº 0.00043s] (1, 3)
// ä¿å­˜æ›´æ”¹
INFO Engine COMMIT

// è‡ªåŠ¨å¼€å§‹ä¸€ä¸ªæ–°çš„äº‹åŠ¡
INFO Engine BEGIN (implicit)

// è®¿é—®å±æ€§ .heroes æ—¶è‡ªåŠ¨åˆ·æ–°æ•°æ®
INFO Engine SELECT team.id AS team_id, team.name AS team_name, team.headquarters AS team_headquarters
FROM team
WHERE team.id = ?
INFO Engine [ç”Ÿæˆäº 0.00029s] (1,)
INFO Engine SELECT hero.id AS hero_id, hero.name AS hero_name, hero.secret_name AS hero_secret_name, hero.age AS hero_age
FROM hero, heroteamlink
WHERE ? = heroteamlink.team_id AND hero.id = heroteamlink.hero_id
INFO Engine [ç¼“å­˜è‡ª 0.5625s å‰] (1,)

// æ‰“å°æ’¤é”€æ›´æ”¹åçš„ Z-Force è‹±é›„
æ’¤é”€åçš„ Z-Force è‹±é›„: [
    Hero(name='Deadpond', age=None, id=1, secret_name='Dive Wilson')
]

// è®¿é—®å±æ€§ .teams æ—¶è‡ªåŠ¨åˆ·æ–°æ•°æ®
INFO Engine SELECT hero.id AS hero_id, hero.name AS hero_name, hero.secret_name AS hero_secret_name, hero.age AS hero_age
FROM hero
WHERE hero.id = ?
INFO Engine [ç¼“å­˜è‡ª 0.4209s å‰] (3,)
INFO Engine SELECT team.id AS team_id, team.name AS team_name, team.headquarters AS team_headquarters
FROM team, heroteamlink
WHERE ? = heroteamlink.hero_id AND team.id = heroteamlink.team_id
INFO Engine [ç¼“å­˜è‡ª 0.5842s å‰] (3,)

// æ‰“å°æ’¤é”€æ›´æ”¹åçš„ Spider-Boy é˜Ÿä¼
æ’¤é”€åçš„ Spider-Boy é˜Ÿä¼: [
    Team(id=2, name='Preventers', headquarters='Sharp Tower')
]

// è‡ªåŠ¨å›æ»šä»»ä½•å¯èƒ½å°šæœªä¿å­˜çš„äº‹åŠ¡
INFO Engine ROLLBACK

```

</div>

## æ€»ç»“

åœ¨è®¾ç½®å¥½ **è¿æ¥æ¨¡å‹** å’Œå…³ç³»å±æ€§ä¹‹åï¼Œæ›´æ–°å’Œç§»é™¤å¤šå¯¹å¤šå…³ç³»æ˜¯ç›¸å½“ç®€å•çš„ã€‚

æ‚¨åªéœ€ä½¿ç”¨å¸¸è§çš„åˆ—è¡¨æ“ä½œå³å¯ã€‚ ğŸš€
